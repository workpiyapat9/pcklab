<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSH/PKU Stock Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        html { font-size: 18px; }
        @media (max-width: 640px) {
            html { font-size: 16px; }
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
        .code-chip {
            display: inline-block;
            padding: 4px 10px;
            background: #e2e8f0;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
            margin: 3px;
            border: 1px solid #cbd5e1;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .auto-label {
            cursor: default;
            user-select: none;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[100] loading-overlay flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <p id="loadingText" class="font-bold text-slate-600 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <!-- Header -->
    <nav class="sticky top-0 z-40 bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-2xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-none">TSH/PKU Stock Manager</h1>
                    <span id="syncStatus" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Checking...</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button onclick="toggleMenu(event)" class="p-2 bg-slate-100 rounded-lg text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div id="navDropdown" class="hidden absolute right-6 top-16 w-56 bg-white rounded-2xl shadow-2xl border border-slate-100 py-2 z-50">
                    <button onclick="showPage(1)" class="w-full text-left px-4 py-3 hover:bg-blue-50 font-bold text-slate-700">üì® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à</button>
                    <button onclick="showPage(2)" class="w-full text-left px-4 py-3 hover:bg-blue-50 font-bold text-slate-700">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Ñ/‡πÄ‡∏ö‡∏¥‡∏Å</button>
                    <button onclick="showPage(3)" class="w-full text-left px-4 py-3 hover:bg-blue-50 font-bold text-slate-700">üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</button>
                    <hr class="my-2">
                    <button onclick="fetchFromSheet()" class="w-full text-left px-4 py-3 text-blue-600 font-bold">üîÑ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto px-4 mt-6">
        
        <!-- Page 1: Sending -->
        <div id="page1" class="page-content space-y-6">
            <div class="bg-white rounded-[2rem] p-6 card-shadow border border-slate-100">
                <h2 class="text-xl font-bold text-slate-700 mb-6 flex items-center">
                    <span class="mr-2">üì®</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à
                </h2>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="dateInput1" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 ml-1">‡πÄ‡∏•‡∏Ç HN</label>
                            <input type="text" id="hnInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ HN" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold text-emerald-600">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                        <input type="text" id="codeSingle" oninput="autoFetchUnit()" onblur="formatCodeInput(this)" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô 1/10" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold text-blue-800">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 ml-1 uppercase tracking-tighter">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                        <div class="relative">
                            <input type="text" id="noteInput1" placeholder="‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©..." readonly tabindex="-1" class="auto-label w-full p-3 bg-slate-100/80 rounded-xl border border-dashed border-slate-300 outline-none font-bold text-blue-600">
                            <div id="unitStatus" class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold"></div>
                        </div>
                    </div>

                    <button onclick="saveTransaction('send')" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all text-lg mt-2">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 2: Stock Management -->
        <div id="page2" class="page-content hidden space-y-6">
            <div class="bg-white rounded-[2rem] p-6 card-shadow border border-slate-100">
                <div class="flex p-1 bg-slate-100 rounded-2xl mb-6">
                    <button id="subBtnIn" onclick="switchStockMode('in')" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-blue-600 border border-blue-50">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    <button id="subBtnWithdraw" onclick="switchStockMode('withdraw')" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all text-slate-500">üì§ ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢</button>
                    <button id="subBtnQuickDeduct" onclick="switchStockMode('quick')" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all text-slate-500">‚úÇÔ∏è ‡∏ï‡∏±‡∏î‡∏î‡πà‡∏ß‡∏ô</button>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="dateInput2" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 ml-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
                            <input type="number" id="quantityInput" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-black text-blue-600">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label id="codeRangeLabel" class="text-xs font-bold text-slate-400 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏ñ‡∏∂‡∏á)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="codeStart" oninput="autoCalcQty()" onblur="formatCodeInput(this)" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô 1/10)" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold">
                            <input type="text" id="codeEnd" oninput="autoCalcQty()" onblur="formatCodeInput(this)" placeholder="‡∏ñ‡∏∂‡∏á (‡πÄ‡∏ä‡πà‡∏ô 100/10)" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold">
                        </div>
                    </div>

                    <div id="excludeContainer" class="hidden space-y-1">
                        <label class="text-xs font-bold text-slate-400 ml-1">‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏´‡∏±‡∏™ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ / ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤)</label>
                        <input type="text" id="excludeCodes" oninput="autoCalcQty()" placeholder="‡πÄ‡∏ä‡πà‡∏ô 21, 33, 43" class="w-full p-3 bg-red-50/50 rounded-xl border border-red-100 outline-none font-bold text-red-500">
                    </div>

                    <div class="space-y-1">
                        <label id="sourceLabel" class="text-xs font-bold text-slate-400 ml-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</label>
                        <div id="noteSelectContainer2">
                            <select id="noteSelect2" onchange="handleSelectChange(2)" class="w-full p-3 bg-white rounded-xl border border-slate-200 outline-none font-bold text-slate-700">
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                                <option value="‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏±‡πâ‡∏ô6">‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏±‡πâ‡∏ô 6</option>
                                <option value="‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä">‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä</option>
                                <option value="NICU">NICU</option>
                                <option value="OPD‡πÄ‡∏î‡πá‡∏Å">OPD ‡πÄ‡∏î‡πá‡∏Å</option>
                                <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                            </select>
                        </div>
                        <input type="text" id="noteInput2" value="‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä" readonly class="hidden w-full p-3 bg-slate-100 rounded-xl border border-slate-200 outline-none font-bold text-slate-500 mt-2">
                    </div>

                    <button id="stockSubmitBtn" onclick="saveTransaction(currentStockMode)" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all text-lg mt-2">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 3: Summary -->
        <div id="page3" class="page-content hidden space-y-4">
            <div class="bg-white rounded-[2rem] p-6 card-shadow border border-slate-100">
                <h2 class="text-lg font-bold text-slate-700 mb-4">üìà ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div class="chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
            <div id="stockSummary" class="space-y-4"></div>
        </div>

        <!-- History -->
        <div id="historySection" class="mt-8 space-y-4">
            <div class="flex items-center justify-between px-2">
                <h3 class="font-bold text-slate-500 text-sm uppercase tracking-widest">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <span id="totalCentralStock" class="text-xs font-bold text-blue-500">‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á: 0 ‡πÉ‡∏ö</span>
            </div>
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-[60] text-sm font-bold"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6vG6bZwtGE1gkZtzb_ikY0kwCKA8cxuVVW3oy8mKiHBqh-UWJtvOFujjoJChSi-OvMA/exec"; 
        const STORAGE_KEY = 'tsh_pku_v19_exclude_logic';
        const NOT_FOUND_LABEL = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ)";
        
        let transactions = [];
        let unitInventory = {}; 
        let currentStockMode = 'in';
        let stockChart = null;

        window.onload = function() {
            setTodayDate();
            fetchFromSheet();
        };

        function setTodayDate() {
            const today = new Date();
            const formatted = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear() + 543}`;
            document.getElementById('dateInput1').value = formatted;
            document.getElementById('dateInput2').value = formatted;
        }

        function formatCodeInput(el) {
            let val = el.value.trim();
            if (val.includes('/')) {
                let [num, suffix] = val.split('/');
                if (num && suffix) {
                    if (!isNaN(num) && num.length > 0) {
                        num = num.padStart(3, '0');
                        el.value = `${num}/${suffix}`;
                    }
                }
            }
            if (el.id === 'codeSingle') autoFetchUnit();
            if (el.id === 'codeStart' || el.id === 'codeEnd') autoCalcQty();
        }

        async function fetchFromSheet() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...");
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                if (data && Array.isArray(data)) {
                    transactions = data.map((item, idx) => ({ ...item, sheetRow: idx + 2 })); 
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                    updateStatus(true);
                }
            } catch (err) {
                transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                updateStatus(false);
            } finally {
                render();
                hideLoading();
            }
        }

        function updateStatus(online) {
            const el = document.getElementById('syncStatus');
            el.innerText = online ? "ONLINE (Synced)" : "OFFLINE MODE";
            el.className = `text-[10px] font-bold uppercase tracking-widest ${online ? 'text-emerald-500' : 'text-red-500'}`;
        }

        function showPage(num) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById('page' + num).classList.remove('hidden');
            document.getElementById('navDropdown').classList.add('hidden');
            render(); 
        }

        function switchStockMode(mode) {
            currentStockMode = mode;
            const btnIn = document.getElementById('subBtnIn');
            const btnW = document.getElementById('subBtnWithdraw');
            const btnQ = document.getElementById('subBtnQuickDeduct');
            const noteInput = document.getElementById('noteInput2');
            const noteSelect = document.getElementById('noteSelectContainer2');
            const excludeContainer = document.getElementById('excludeContainer');
            const submitBtn = document.getElementById('stockSubmitBtn');

            [btnIn, btnW, btnQ].forEach(b => b.className = "flex-1 py-2 rounded-xl text-sm font-bold transition-all text-slate-500");

            if(mode === 'in') {
                btnIn.className = "flex-1 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-blue-600 border border-blue-50";
                noteInput.value = "‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä";
                noteInput.classList.remove('hidden');
                noteSelect.classList.add('hidden');
                excludeContainer.classList.add('hidden');
                submitBtn.innerText = "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á";
                document.getElementById('excludeCodes').value = "";
            } else {
                const isWithdraw = mode === 'withdraw';
                const activeClass = isWithdraw ? "text-orange-600 border-orange-100 shadow-sm bg-white" : "text-red-600 border-red-100 shadow-sm bg-white";
                (isWithdraw ? btnW : btnQ).className = `flex-1 py-2 rounded-xl text-sm font-bold border ${activeClass}`;
                noteInput.classList.add('hidden');
                noteSelect.classList.remove('hidden');
                excludeContainer.classList.remove('hidden');
                submitBtn.innerText = isWithdraw ? "‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" : "‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏î‡πà‡∏ß‡∏ô (‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢)";
            }
            autoCalcQty();
        }

        function handleSelectChange(p) {
            const sel = document.getElementById('noteSelect' + p);
            const inp = document.getElementById('noteInput' + p);
            if(sel.value === 'other') { inp.classList.remove('hidden'); inp.value = ""; inp.focus(); }
            else { inp.classList.add('hidden'); inp.value = sel.value; }
        }

        function autoCalcQty() {
            const s = document.getElementById('codeStart').value;
            const e = document.getElementById('codeEnd').value;
            const excludeStr = document.getElementById('excludeCodes').value;
            const excludeIsHidden = document.getElementById('excludeContainer').classList.contains('hidden');
            
            if (s.includes('/') && e.includes('/')) {
                const sN = parseInt(s.split('/')[0]);
                const eN = parseInt(e.split('/')[0]);
                if(!isNaN(sN) && !isNaN(eN)) {
                    let total = Math.abs(eN - sN) + 1;
                    if(!excludeIsHidden && excludeStr.trim()) {
                        const excludes = excludeStr.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
                        const min = Math.min(sN, eN);
                        const max = Math.max(sN, eN);
                        const actualExcludes = [...new Set(excludes)].filter(v => v >= min && v <= max);
                        total -= actualExcludes.length;
                    }
                    document.getElementById('quantityInput').value = total > 0 ? total : 0;
                }
            } else {
                document.getElementById('quantityInput').value = "";
            }
        }

        function parseCodeToItems(codeStr) {
            if(!codeStr || codeStr === '-') return [];
            let excludeList = [];
            let mainPart = codeStr;
            if(codeStr.includes('!')) {
                const parts = codeStr.split('!');
                mainPart = parts[0];
                excludeList = parts[1].split(',').map(v => v.trim());
            }
            if(mainPart.includes('-')) {
                const parts = mainPart.split('-');
                const sParts = parts[0].trim().split('/');
                const eParts = parts[1].trim().split('/');
                if(sParts.length < 2 || eParts.length < 2) return [parts[0].trim()];
                const sNum = parseInt(sParts[0]), eNum = parseInt(eParts[0]), suffix = sParts[1];
                let list = [];
                for(let i = Math.min(sNum, eNum); i <= Math.max(sNum, eNum); i++) {
                    const currentPrefix = String(i).padStart(3, '0');
                    if(!excludeList.includes(currentPrefix)) {
                        list.push(`${currentPrefix}/${suffix}`);
                    }
                }
                return list;
            }
            return [mainPart.trim()];
        }

        function formatCodeRange(codesSet) {
            const codes = Array.from(codesSet);
            const groups = {};
            codes.forEach(c => {
                const p = c.split('/'); if(p.length < 2) return;
                const n = parseInt(p[0]), s = p[1];
                if (!groups[s]) groups[s] = []; groups[s].push(n);
            });
            let res = [];
            for (const s in groups) {
                const nums = groups[s].sort((a,b)=>a-b);
                let start = nums[0], prev = nums[0];
                for (let i = 1; i <= nums.length; i++) {
                    if (nums[i] !== prev + 1 || i === nums.length) {
                        res.push(start === prev ? `${String(start).padStart(3,'0')}/${s}` : `${String(start).padStart(3,'0')}-${String(prev).padStart(3,'0')}/${s}`);
                        start = nums[i];
                    }
                    prev = nums[i];
                }
            }
            return res;
        }

        function autoFetchUnit() {
            const codeRaw = document.getElementById('codeSingle').value.trim();
            const noteDisplay = document.getElementById('noteInput1');
            const status = document.getElementById('unitStatus');
            if(!codeRaw) { noteDisplay.value = ""; status.innerText = ""; return; }
            let searchCode = codeRaw;
            if (codeRaw.includes('/')) {
                let [n, s] = codeRaw.split('/');
                if(!isNaN(n) && n.length > 0) searchCode = `${n.padStart(3, '0')}/${s}`;
            }
            let found = Object.keys(unitInventory).find(u => u !== "‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á" && unitInventory[u].has(searchCode));
            if(found) {
                noteDisplay.value = found;
                status.innerText = "‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö";
                status.className = "absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-emerald-500";
            } else {
                noteDisplay.value = NOT_FOUND_LABEL;
                status.innerText = "‚ùì ‡πÑ‡∏°‡πà‡∏û‡∏ö";
                status.className = "absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400";
            }
        }

        async function saveTransaction(type) {
            const page = (type === 'send') ? 1 : 2;
            const date = document.getElementById('dateInput' + page).value;
            const note = document.getElementById('noteInput' + page).value;
            if(!note || !date) return showToast("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "bg-orange-500");
            let data = { action: 'add', date, type, note };
            if(type === 'send') {
                data.hn = document.getElementById('hnInput').value;
                data.code = document.getElementById('codeSingle').value;
                data.quantity = 1;
                if(!data.hn || !data.code) return showToast("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏ HN ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™");
            } else {
                data.quantity = parseInt(document.getElementById('quantityInput').value);
                const s = document.getElementById('codeStart').value;
                const e = document.getElementById('codeEnd').value;
                const exContainer = document.getElementById('excludeContainer');
                const ex = document.getElementById('excludeCodes').value.trim();
                let codeVal = (s && e) ? `${s}-${e}` : (s || "-");
                if(!exContainer.classList.contains('hidden') && ex) {
                    const cleanEx = ex.split(',').map(v => v.trim().padStart(3, '0')).filter(v => v !== '000').join(',');
                    if(cleanEx) codeVal += `!${cleanEx}`;
                }
                data.code = codeVal;
                if(!data.quantity || data.quantity <= 0) return showToast("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' });
                showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                if(page === 2) {
                    document.getElementById('excludeCodes').value = "";
                    document.getElementById('codeStart').value = "";
                    document.getElementById('codeEnd').value = "";
                    document.getElementById('quantityInput').value = "";
                }
                if(page === 1) {
                    document.getElementById('hnInput').value = "";
                    document.getElementById('codeSingle').value = "";
                    document.getElementById('noteInput1').value = "";
                }
                fetchFromSheet();
            } catch (err) { showToast("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "bg-red-500"); } finally { hideLoading(); }
        }

        function updateChart(chartData) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) stockChart.destroy();
            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: chartData.labels.map(l => l === '‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á' ? '#3b82f6' : '#cbd5e1'),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        function render() {
            const list = document.getElementById('historyList');
            const summary = document.getElementById('stockSummary');
            const centralEl = document.getElementById('totalCentralStock');
            
            list.innerHTML = ""; summary.innerHTML = "";
            unitInventory = { "‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á": new Set() };

            transactions.forEach(t => {
                const codes = parseCodeToItems(t.code);
                if (t.type === 'in') codes.forEach(c => unitInventory["‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á"].add(c));
                else if (t.type === 'withdraw') {
                    if (!unitInventory[t.note]) unitInventory[t.note] = new Set();
                    codes.forEach(c => { unitInventory["‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á"].delete(c); unitInventory[t.note].add(c); });
                } 
                else if ((t.type === 'send' || t.type === 'quick') && t.note !== NOT_FOUND_LABEL && unitInventory[t.note]) {
                    codes.forEach(c => unitInventory[t.note].delete(c));
                }
            });

            transactions.slice().reverse().slice(0, 15).forEach(t => {
                let icon = 'üì¶', color = 'text-blue-600', isNoDeduct = t.note === NOT_FOUND_LABEL;
                if(t.type === 'withdraw') icon = 'üì§', color = 'text-orange-600';
                else if(t.type === 'send') icon = 'üì®', color = 'text-emerald-600';
                else if(t.type === 'quick') icon = '‚úÇÔ∏è', color = 'text-red-600';

                list.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm relative group overflow-hidden ${isNoDeduct ? 'opacity-60' : ''}">
                        <div class="flex items-center space-x-3 overflow-hidden">
                            <div class="text-xl p-2 bg-slate-50 rounded-xl flex-shrink-0">${icon}</div>
                            <div class="truncate">
                                <div class="text-[9px] font-bold text-slate-400 uppercase">${t.date} ${t.hn ? '| HN:'+t.hn : ''}</div>
                                <div class="font-bold text-slate-700 leading-tight truncate">${t.note}</div>
                                <div class="text-[9px] text-slate-400 italic">Code: ${t.code}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="text-lg font-black ${isNoDeduct ? 'text-slate-300' : color}">
                                ${(t.type === 'in' || (t.type === 'withdraw' && t.note !== "‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á")) ? '+' : (isNoDeduct ? '' : '-')}${isNoDeduct ? '0' : t.quantity}
                            </div>
                        </div>
                    </div>
                `);
            });

            centralEl.innerText = `‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á: ${unitInventory["‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á"].size} ‡πÉ‡∏ö`;
            const chartData = { labels: [], values: [] };
            Object.keys(unitInventory).forEach(unit => {
                const count = unitInventory[unit].size;
                if(count > 0 || unit === "‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á") { chartData.labels.push(unit); chartData.values.push(count); }
                summary.insertAdjacentHTML('beforeend', `
                    <div class="bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm p-4 flex justify-between items-center">
                        <div class="text-left">
                            <h3 class="font-bold text-slate-700">${unit}</h3>
                            <div class="flex flex-wrap gap-1 mt-2">${formatCodeRange(unitInventory[unit]).map(r=>`<span class="code-chip">${r}</span>`).join('') || '<span class="text-xs italic text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</span>'}</div>
                        </div>
                        <div class="text-blue-600 font-black text-2xl ml-4">${count}</div>
                    </div>
                `);
            });
            if (!document.getElementById('page3').classList.contains('hidden')) updateChart(chartData);
        }

        function toggleMenu(e) { e.stopPropagation(); document.getElementById('navDropdown').classList.toggle('hidden'); }
        window.onclick = () => document.getElementById('navDropdown').classList.add('hidden');
        function showLoading(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showToast(m, b="bg-slate-800") {
            const t = document.getElementById('toast'); t.innerText = m; t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-2xl transition-opacity z-[60] text-sm font-bold ${b}`;
            t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 2500);
        }
    </script>
</body>
</html>
